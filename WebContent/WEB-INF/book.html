<!DOCTYPE html>
<html>

<head>
<link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
<link type="text/css" rel="stylesheet" href="css/index.css"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
html, body {
	height: 100%;
	margin: 0;
	padding: 0;
}

#map {
	height: 80%;
}
</style>
<title>Choose pickup and drop-off location - RadioTaxi</title>
</head>

<body>
	<input id="pac-input" class="controls" type="text" placeholder="Enter a location">
	<div id="map"></div>
	<!-- holds the google map -->
	<script type="text/javascript">
		// https://developers.google.com/maps/documentation/javascript/tutorial
		var map;

		function initMap() {

			var bounds = new google.maps.LatLngBounds;
			var defaultLatLng = {
				lat : 23.4461269,
				lng : 75.6002234
			};
			// https://developers.google.com/maps/documentation/javascript/controls
			var mapOptions = {
				center : defaultLatLng,
				zoom : 13,
				streetViewControl : false,
				mapTypeControl : false,
			}
			map = new google.maps.Map(document.getElementById('map'),
					mapOptions);

			// https://developers.google.com/maps/documentation/javascript/markers
			var originMarker = new google.maps.Marker({ // pickup location marker ('A')
				position : defaultLatLng,
				title : 'Pickup Location',
				draggable : true,
				label : 'A'
			});

			var destMarker = new google.maps.Marker({ // drop-off location marker ('B')
				position : defaultLatLng,
				title : 'Drop Location',
				draggable : true,
				label : 'B'
			});

			originMarker.setMap(map);
			destMarker.setMap(map);

			// get user location (geolocation)
			// https://developers.google.com/maps/documentation/javascript/examples/map-geolocation
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function(position) {
					var pos = {
						lat : position.coords.latitude,
						lng : position.coords.longitude
					};

					// http://stackoverflow.com/questions/8840727/api-v3-update-marker-position-dynamically
					originMarker.setPosition(pos);
					// http://stackoverflow.com/questions/11030730/getting-coordinates-of-marker-in-google-maps-api
					destMarker.setPosition(new google.maps.LatLng(originMarker
							.getPosition().lat() + 0.01, originMarker
							.getPosition().lng() + 0.01));
					// Added 0.01 to lat-long to place destMarker near the originMarker
					//console.log("origin marker at " + originMarker.position);
					map.setCenter(pos);

				}, function() {
					handleLocationError(true, map.getCenter());
				});
			} else {
				// Browser doesn't support Geolocation
				handleLocationError(false, map.getCenter());
			}
			// end get user location

			// distance calculation
			// https://developers.google.com/maps/documentation/javascript/distancematrix#distance_matrix_requests
			// https://developers.google.com/maps/documentation/javascript/distancematrix#distance_matrix_parsing_the_results
			// https://developers.google.com/maps/documentation/javascript/examples/distance-matrix

			var geocoder = new google.maps.Geocoder;
			var service = new google.maps.DistanceMatrixService;

			// https://developers.google.com/maps/documentation/javascript/reference#DistanceMatrixRequest
			var getDistanceMatrixRequest = {
				origins : [ defaultLatLng ],
				destinations : [ defaultLatLng ],
				travelMode : google.maps.TravelMode.DRIVING,
				unitSystem : google.maps.UnitSystem.METRIC,
				avoidHighways : false,
				avoidTolls : false
			}

			// https://developers.google.com/maps/documentation/javascript/events
			// https://developers.google.com/maps/documentation/javascript/reference#Marker
			originMarker
					.addListener(
							'dragend',
							function() {
								//console.log("dragend on originMarker");
								getDistanceMatrixRequest.origins = [ new google.maps.LatLng(
										originMarker.getPosition().lat(),
										originMarker.getPosition().lng()) ];
								getDistanceMatrixRequest.destinations = [ new google.maps.LatLng(
										destMarker.getPosition().lat(),
										destMarker.getPosition().lng()) ];
								//console.log(getDistanceMatrixRequest);
								service.getDistanceMatrix(
										getDistanceMatrixRequest,
										getDistanceMatrixCallback);
							});
			destMarker
					.addListener(
							'dragend',
							function() {
								//console.log("dragend on destMarker");
								getDistanceMatrixRequest.origins = [ new google.maps.LatLng(
										originMarker.getPosition().lat(),
										originMarker.getPosition().lng()) ];
								document.getElementById("orig_lat").value = originMarker.getPosition().lat();
								document.getElementById("orig_lng").value = originMarker.getPosition().lng();
								getDistanceMatrixRequest.destinations = [ new google.maps.LatLng(
										destMarker.getPosition().lat(),
										destMarker.getPosition().lng()) ];
								document.getElementById("dest_lat").value = destMarker.getPosition().lat();
								document.getElementById("dest_lng").value = destMarker.getPosition().lng();
								//console.log(getDistanceMatrixRequest);
								service.getDistanceMatrix(
										getDistanceMatrixRequest,
										getDistanceMatrixCallback);
							});

			function getDistanceMatrixCallback(response, status) {
				//console.log("service.getDistanceMatrixCallback() called");
				if (status !== google.maps.DistanceMatrixStatus.OK) {
					alert('Error was: ' + status);
				} else {
					var origins = response.originAddresses;
					var destinations = response.destinationAddresses;
					var outputDiv = document.getElementById('output');
					outputDiv.innerHTML = '';

					for (var i = 0; i < origins.length; i++) {
						var results = response.rows[i].elements;
						for (var j = 0; j < results.length; j++) {
							outputDiv.innerHTML += 'Distance: '
									+ results[j].distance.text + '<br />'
									+ 'Estimated time: '
									+ results[j].duration.text + '<br>';
							document.getElementById("origin").value = origins[i];
							document.getElementById("dest").value = destinations[j];
							document.getElementById("distance").value = results[j].distance.text;
							document.getElementById("time").value = results[j].duration.text;
						}
					}
				}
			}
			;
			// end distance calculation
			
			/*
			// place ID finder
			// https://developers.google.com/maps/documentation/javascript/examples/places-placeid-finder
			
			var inputPlaceId = document.getElementById('pac-input');

			var autocomplete = new google.maps.places.Autocomplete(inputPlaceId);
			autocomplete.bindTo('bounds', map);

			map.controls[google.maps.ControlPosition.TOP_LEFT].push(inputPlaceId);
			// var infowindow = new google.maps.InfoWindow();

		  	autocomplete.addListener('place_changed', function() {
			    // infowindow.close();
			    var place = autocomplete.getPlace();
			    if (!place.geometry) {
			      return;
			    }
	
			    if (place.geometry.viewport) {
			      map.fitBounds(place.geometry.viewport);
			    } else {
			      map.setCenter(place.geometry.location);
			      map.setZoom(17);
			    }
	
			    // Set the position of the marker using the place ID and location.
			    originMarker.setPlace({
			      placeId: place.place_id,
			      location: place.geometry.location
			    });
	
			    /*
			    infowindow.setContent('<div><strong>' + place.name + '</strong><br>' +
			        'Place ID: ' + place.place_id + '<br>' +
			        place.formatted_address);
			    infowindow.open(map, marker);
			    */
			/*
		  	});
			*/
		}

		// function to handle geolocation errors
		// https://developers.google.com/maps/documentation/javascript/infowindows
		function handleLocationError(browserHasGeolocation, pos) {
			var infoWindow = new google.maps.InfoWindow({
				map : map
			});
			infoWindow.setPosition(pos);
			infoWindow
					.setContent(browserHasGeolocation ? 'Error: The Geolocation service failed.'
							: 'Error: Your browser doesn\'t support geolocation.');
		}

	</script>
	<!-- Google Maps API load configuration
    https://developers.google.com/maps/documentation/javascript/basics#Region
    https://developers.google.com/maps/documentation/javascript/versions
     -->
	<script async defer
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCokkwucFGJh3PhBb13X7iNX6gs1txvVQQ&v=3&region=IN&callback=initMap&libraries=places">
	</script>
		
	<div id="output">Drag and drop marker B at the destination, or enter your destination in the field below!</div>
	
	<form action="book" method="post" name="bookForm" onsubmit="return validateBookForm()">
	<div class="row">
		<div class="input-field col s4">
			<input type="text" name="origin" id="origin" class="validate">
		</div>
		<div class="input-field col s4">
			<input type="text" name="dest" id="dest" class="validate">
		</div>
		<div class="input-field col s4">
			<button class="btn waves-effect waves-light" id="book_button" type="submit" value="Book"  >Book</button>
		</div>
		<input type="hidden" name="distance" id="distance">
		<input type="hidden" name="time" id="time">
		<input type="hidden" name="orig_lat" id="orig_lat">
		<input type="hidden" name="orig_lng" id="orig_lng">
		<input type="hidden" name="dest_lat" id="dest_lat">
		<input type="hidden" name="dest_lng" id="dest_lng">
		<input type="hidden" name="place_id" id="place_id">
	</form>

<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
      <script type="text/javascript" src="js/materialize.min.js"></script>
        <script type="text/javascript" src="js/book.js"></script>

</body>
</html>